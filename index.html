<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Watch Together (Firebase)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#0b1020; color:#e6e9ff; }
    header { padding: 14px 16px; background:#121a33; border-bottom:1px solid rgba(255,255,255,.08); display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .pill { background: rgba(255,255,255,.08); padding: 6px 10px; border-radius: 999px; font-size: 13px;}
    .wrap { display:grid; grid-template-columns: 360px 1fr; gap: 16px; padding: 16px; }
    .card { background:#121a33; border:1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 14px; }
    input, button { width:100%; box-sizing:border-box; padding: 10px 12px; border-radius: 10px; border:1px solid rgba(255,255,255,.15); background:#0b1020; color:#e6e9ff; }
    button { cursor:pointer; background:#2b6cff; border:none; font-weight:600; }
    button.secondary { background: rgba(255,255,255,.12); }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .small { font-size: 12px; opacity: .85; line-height: 1.35; }
    .status { font-size: 13px; opacity:.9; }
    .playerWrap { display:flex; align-items:center; justify-content:center; min-height: 520px; }
    #videoEl { width: 100%; max-height: 70vh; background:#000; border-radius: 12px; }
    #ytWrap { width: 100%; aspect-ratio: 16/9; max-height: 70vh; border-radius: 12px; overflow:hidden; background:#000; display:none; }
    #ytPlayer { width:100%; height:100%; }
    .sep { height:1px; background: rgba(255,255,255,.08); margin: 12px 0; }
    code { background: rgba(255,255,255,.08); padding: 2px 6px; border-radius: 6px; }
    #qr { display:flex; justify-content:center; padding:10px; }
  </style>
</head>
<body>
<header>
  <div class="pill">üé¨ Watch Together (Firebase)</div>
  <div class="pill">Room: <code id="roomCode">‚Äî</code></div>
  <div class="pill status" id="connStatus">üü° connecting‚Ä¶</div>
</header>

<div class="wrap">
  <div class="card">
    <h3 style="margin:0 0 10px;">–ö—ñ–º–Ω–∞—Ç–∞</h3>

    <div class="row">
      <button class="secondary" id="btnNewRoom">‚ûï –ù–æ–≤–∞ –∫—ñ–º–Ω–∞—Ç–∞</button>
      <button class="secondary" id="btnCopyLink">üîó –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ª—ñ–Ω–∫</button>
    </div>

    <div class="sep"></div>

    <label class="small">–õ—ñ–Ω–∫ –Ω–∞ –≤—ñ–¥–µ–æ (YouTube –∞–±–æ –ø—Ä—è–º–∏–π .mp4/.webm):</label>
    <input id="srcInput" placeholder="–ù–∞–ø—Ä: https://youtu.be/dQw4w9WgXcQ –∞–±–æ https://site/video.mp4" />

    <div class="row" style="margin-top:10px;">
      <button id="btnSetSource">‚úÖ –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏</button>
      <button class="secondary" id="btnClear">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
    </div>

    <div class="sep"></div>

    <div class="small">
      ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î Play / Pause / –ø–µ—Ä–µ–º–æ—Ç–∫—É (seek).<br/>
      ‚ö†Ô∏è –ë–∞–≥–∞—Ç–æ —Å–∞–π—Ç—ñ–≤ –Ω–µ –¥–∞—é—Ç—å –≤–±—É–¥—É–≤–∞—Ç–∏ –≤—ñ–¥–µ–æ (X-Frame-Options). –ù–∞–¥—ñ–π–Ω–æ: YouTube –∞–±–æ –ø—Ä—è–º–∏–π —Ñ–∞–π–ª.
    </div>

    <div class="sep"></div>

    <h4 style="margin:0 0 8px;">–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</h4>
    <div class="small">–õ—ñ–Ω–∫:</div>
    <input id="shareLink" readonly />
    <div id="qr"></div>
    <div class="small" style="opacity:.8">QR –ø—Ä–∞—Ü—é—î –∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –±–æ Netlify = HTTPS.</div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">–ü–ª–µ—î—Ä</h3>

    <div class="playerWrap">
      <video id="videoEl" controls playsinline></video>
      <div id="ytWrap"><div id="ytPlayer"></div></div>
    </div>

    <div class="sep"></div>
    <div class="status" id="playStatus">‚Äî</div>
    <div class="small" id="debug">‚Äî</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>

<!-- Firebase (Realtime Database) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getDatabase, ref, set, update, onValue, get, child, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

  // ==========================
  // 1) –í–°–¢–ê–í –°–í–Ü–ô firebaseConfig
  // ==========================
  const firebaseConfig = {
    apiKey: "PASTE_HERE",
    authDomain: "PASTE_HERE",
    databaseURL: "PASTE_HERE",
    projectId: "PASTE_HERE",
    storageBucket: "PASTE_HERE",
    messagingSenderId: "PASTE_HERE",
    appId: "PASTE_HERE"
  };

  // ---------- UI helpers ----------
  const $ = (id) => document.getElementById(id);
  const connStatus = $("connStatus");
  const videoEl = $("videoEl");
  const ytWrap = $("ytWrap");

  function randomRoomCode(len = 6) {
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out = "";
    for (let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }
  function getRoomId() {
    const h = (location.hash || "").replace("#","").trim();
    if (h) return h;
    const code = randomRoomCode();
    location.hash = code;
    return code;
  }
  function setShareUI(roomId) {
    const link = location.origin + "/#" + roomId;
    $("roomCode").textContent = roomId;
    $("shareLink").value = link;
    $("qr").innerHTML = "";
    QRCode.toCanvas(link, { width: 220, margin: 1 }, (err, canvas) => {
      if (!err && canvas) $("qr").appendChild(canvas);
    });
  }
  function setStatus(text){ $("playStatus").textContent = text; }
  function setDebug(text){ $("debug").textContent = text; }

  function parseSource(url) {
    url = (url || "").trim();
    if (!url) return null;

    const yt =
      url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{6,})/) ||
      url.match(/youtube\.com\/embed\/([a-zA-Z0-9_-]{6,})/);

    if (yt && yt[1]) return { type:"youtube", url, videoId: yt[1] };

    if (/\.(mp4|webm|ogg)(\?|#|$)/i.test(url)) return { type:"file", url };

    return { type:"file", url, note:"–¶–µ –Ω–µ YouTube —ñ –Ω–µ –ø—Ä—è–º–∏–π .mp4/.webm. –ú–æ–∂–µ –Ω–µ –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏—Å—å —É <video>." };
  }

  // ---------- YouTube ----------
  let ytPlayer = null;
  let currentType = null;
  let suppressLocalEvents = false;

  function showFilePlayer() {
    currentType = "file";
    ytWrap.style.display = "none";
    videoEl.style.display = "block";
  }
  function showYTPlayer() {
    currentType = "youtube";
    videoEl.style.display = "none";
    ytWrap.style.display = "block";
  }

  function loadYouTubeApi() {
    return new Promise((resolve) => {
      if (window.YT && window.YT.Player) return resolve();
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      window.onYouTubeIframeAPIReady = () => resolve();
      document.head.appendChild(tag);
    });
  }

  async function ensureYTPlayer(videoId, onLocalAction) {
    await loadYouTubeApi();
    if (ytPlayer) {
      ytPlayer.loadVideoById(videoId);
      return;
    }
    ytPlayer = new YT.Player("ytPlayer", {
      videoId,
      playerVars: { playsinline: 1, rel: 0, modestbranding: 1 },
      events: {
        onStateChange: () => {
          if (suppressLocalEvents) return;
          const s = ytPlayer.getPlayerState();
          const t = ytPlayer.getCurrentTime() || 0;
          // 1 playing, 2 paused
          if (s === 1) onLocalAction({ action:"play", time:t });
          if (s === 2) onLocalAction({ action:"pause", time:t });
        }
      }
    });
  }

  // ---------- Firebase init ----------
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const roomId = getRoomId();
  setShareUI(roomId);

  const roomRef = ref(db, `rooms/${roomId}`);
  const stateRef = ref(db, `rooms/${roomId}/state`);

  // Server time offset for accurate play timing
  let serverOffsetMs = 0;
  onValue(ref(db, ".info/serverTimeOffset"), (snap) => {
    serverOffsetMs = snap.val() || 0;
  });

  function nowServerMs() {
    return Date.now() + serverOffsetMs;
  }

  // State model (stored in RTDB):
  // {
  //   url, type, videoId?,
  //   paused: boolean,
  //   pos: number,            // seconds at moment of update
  //   playAtMs: number|null,  // server-time ms when playback started/resumed
  //   updatedAt: serverTimestamp()
  // }

  async function writeState(patch) {
    await update(stateRef, { ...patch, updatedAt: serverTimestamp() });
  }

  function computeExpectedTime(state) {
    if (!state) return 0;
    const base = Number(state.pos || 0);
    if (state.paused) return base;
    const playAt = Number(state.playAtMs || 0);
    if (!playAt) return base;
    const dt = (nowServerMs() - playAt) / 1000;
    return Math.max(0, base + dt);
  }

  async function applyState(state, fromRemote=true) {
    if (!state || !state.url) return;

    $("srcInput").value = state.url;

    const expected = computeExpectedTime(state);
    const isPaused = !!state.paused;

    if (state.type === "youtube") {
      showYTPlayer();
      await ensureYTPlayer(state.videoId, async ({ action, time }) => {
        if (action === "play") {
          await writeState({ paused:false, pos: time, playAtMs: nowServerMs() });
          setStatus("‚ñ∂Ô∏è Play (YouTube)");
        }
        if (action === "pause") {
          await writeState({ paused:true, pos: time, playAtMs: null });
          setStatus("‚è∏ Pause (YouTube)");
        }
      });

      suppressLocalEvents = true;
      ytPlayer.seekTo(expected, true);
      if (isPaused) ytPlayer.pauseVideo(); else ytPlayer.playVideo();
      suppressLocalEvents = false;
    } else {
      showFilePlayer();
      if (videoEl.src !== state.url) videoEl.src = state.url;

      suppressLocalEvents = true;
      try { videoEl.currentTime = expected; } catch {}
      if (isPaused) {
        videoEl.pause();
      } else {
        videoEl.play().catch(()=>{});
      }
      suppressLocalEvents = false;
    }

    setDebug((fromRemote ? "üîÅ remote " : "üß† local ") + JSON.stringify({
      type: state.type, paused: isPaused, expected: Math.round(expected*10)/10
    }));
  }

  // Subscribe to room state
  onValue(stateRef, (snap) => {
    const state = snap.val();
    // If we triggered this update ourselves, suppressLocalEvents already handles loops
    applyState(state, true);
    connStatus.textContent = "üü¢ connected";
  }, (err) => {
    connStatus.textContent = "üî¥ firebase error";
    console.error(err);
  });

  // Ensure room exists (optional)
  const roomSnap = await get(roomRef);
  if (!roomSnap.exists()) {
    await set(roomRef, { createdAt: serverTimestamp() });
  }

  // ---------- Local player events (File) ----------
  videoEl.addEventListener("play", async () => {
    if (suppressLocalEvents) return;
    await writeState({ paused:false, pos: videoEl.currentTime || 0, playAtMs: nowServerMs() });
    setStatus("‚ñ∂Ô∏è Play (File)");
  });
  videoEl.addEventListener("pause", async () => {
    if (suppressLocalEvents) return;
    await writeState({ paused:true, pos: videoEl.currentTime || 0, playAtMs: null });
    setStatus("‚è∏ Pause (File)");
  });
  videoEl.addEventListener("seeking", async () => {
    if (suppressLocalEvents) return;
    const t = videoEl.currentTime || 0;
    // preserve paused/playing logic
    const st = (await get(stateRef)).val() || {};
    if (st.paused) {
      await writeState({ pos: t, playAtMs: null });
      setStatus("‚è© Seek (File, paused)");
    } else {
      await writeState({ pos: t, playAtMs: nowServerMs() });
      setStatus("‚è© Seek (File, playing)");
    }
  });

  // ---------- UI actions ----------
  $("btnNewRoom").addEventListener("click", () => {
    const code = randomRoomCode();
    location.hash = code;
    location.reload();
  });

  $("btnCopyLink").addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText($("shareLink").value);
      connStatus.textContent = "üü¢ copied link";
      setTimeout(()=> connStatus.textContent = "üü¢ connected", 900);
    } catch {
      alert("–ù–µ –≤–¥–∞–ª–æ—Å—å —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏. –°–∫–æ–ø—ñ—é–π –≤—Ä—É—á–Ω—É –∑ –ø–æ–ª—è.");
    }
  });

  $("btnSetSource").addEventListener("click", async () => {
    const url = $("srcInput").value.trim();
    const s = parseSource(url);
    if (!s) return;
    if (s.note) alert(s.note);

    // Reset playback state when source changes
    const initState = {
      url: s.url,
      type: s.type,
      videoId: s.videoId || null,
      paused: true,
      pos: 0,
      playAtMs: null
    };
    await set(stateRef, { ...initState, updatedAt: serverTimestamp() });
    setStatus("‚úÖ Source set");
  });

  $("btnClear").addEventListener("click", async () => {
    $("srcInput").value = "";
    suppressLocalEvents = true;
    videoEl.pause();
    videoEl.removeAttribute("src");
    videoEl.load();
    if (ytPlayer) ytPlayer.stopVideo();
    suppressLocalEvents = false;
    await set(stateRef, { url:"", type:"file", paused:true, pos:0, playAtMs:null, updatedAt: serverTimestamp() });
    setStatus("‚Äî");
    setDebug("‚Äî");
  });
</script>
</body>
</html>
